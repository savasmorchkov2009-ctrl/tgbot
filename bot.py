import os
import random
import logging
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command
from aiogram.types import Message, InlineKeyboardMarkup, InlineKeyboardButton, ReplyKeyboardRemove
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.utils.keyboard import InlineKeyboardBuilder
from dotenv import load_dotenv

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
BOT_TOKEN = os.getenv("5932864783:AAFbN42qyJBtbuyqo3wD2i2I3OTKEdpq1qI")
ADMIN_ID = int(os.getenv("5189651311"))  # ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞—è–≤–æ–∫

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
bot = Bot(token=BOT_TOKEN)
storage = MemoryStorage()
dp = Dispatcher(storage=storage)

# –°—Å—ã–ª–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–∏)
VK_REVIEW_LINK = "https://clck.ru/3QTvTp"
YANDEX_REVIEW_LINK = "https://clck.ru/3QTRfj"
TWOGIS_REVIEW_LINK = "https://clck.ru/3QsAsL"

# –°–æ—Å—Ç–æ—è–Ω–∏—è FSM
class UserState(StatesGroup):
    waiting_for_screenshot = State()
    waiting_for_phone = State()
    waiting_for_bank = State()

# –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ë–î)
user_data = {}

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏
def get_main_keyboard():
    keyboard = InlineKeyboardBuilder()
    keyboard.add(
        InlineKeyboardButton(text="‚≠ê –ë–æ–Ω—É—Å –∑–∞ –æ—Ç–∑—ã–≤ 5", callback_data="get_bonus"),
        InlineKeyboardButton(text="üìò –û—Ç–∑—ã–≤ –≤ VK", url=VK_REVIEW_LINK),
        InlineKeyboardButton(text="üåê –û—Ç–∑—ã–≤ –≤ –Ø–Ω–¥–µ–∫—Å–µ", url=YANDEX_REVIEW_LINK),
        InlineKeyboardButton(text="üó∫Ô∏è –û—Ç–∑—ã–≤ –≤ 2–ì–ò–°", url=TWOGIS_REVIEW_LINK)
    )
    keyboard.adjust(1)
    return keyboard.as_markup()

# –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
@dp.message(Command("start"))
async def cmd_start(message: Message):
    welcome_text = """–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! üòä

–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–Ω—É—Å–æ–≤!
–†–∞–∑–º–µ—Ä –ø—Ä–∏–∑–∞ –æ—Ç 150 –¥–æ 200 —Ä—É–±–ª–µ–π

–í—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤—ã –Ω–∞ –¥—Ä—É–≥–∏—Ö –ø–ª–æ—â–∞–¥–∫–∞—Ö –∏ –ø–æ–ª—É—á–∏—Ç—å –±–æ–Ω—É—Å!"""
    
    await message.answer(welcome_text, reply_markup=get_main_keyboard())

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–ë–æ–Ω—É—Å –∑–∞ –æ—Ç–∑—ã–≤"
@dp.callback_query(F.data == "get_bonus")
async def process_bonus(callback: types.CallbackQuery, state: FSMContext):
    instructions = """‚≠ê –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –±–æ–Ω—É—Å:

1. –û—Å—Ç–∞–≤—å—Ç–µ –æ—Ç–∑—ã–≤ –Ω–∞ ‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è –æ –Ω–∞—à–µ–º —Å–µ—Ä–≤–∏—Å–µ (–ê–≤–∏—Ç–æ, –°—É—Ç–æ—á–Ω–æ, –û—Å—Ç—Ä–æ–≤–æ–∫, –û–∑–æ–Ω, –í–ö, –Ø–Ω–¥–µ–∫—Å)
2. –°–¥–µ–ª–∞–π—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –≤–∞—à–µ–≥–æ –æ—Ç–∑—ã–≤–∞
3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç —Å—é–¥–∞

–ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —Å–ª—É—á–∞–π–Ω—ã–π –¥–µ–Ω–µ–∂–Ω—ã–π –ø—Ä–∏–∑ –æ—Ç 150 –¥–æ 200 —Ä—É–±–ª–µ–π!

–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –æ—Ç–∑—ã–≤–∞:"""
    
    await callback.message.edit_text(instructions)
    await state.set_state(UserState.waiting_for_screenshot)
    await callback.answer()

# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞
@dp.message(UserState.waiting_for_screenshot, F.photo)
async def process_screenshot(message: Message, state: FSMContext):
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—É—é —Å—É–º–º—É –æ—Ç 150 –¥–æ 200
    prize_amount = random.randint(150, 200)
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_data[message.from_user.id] = {
        "user_id": message.from_user.id,
        "username": message.from_user.username,
        "full_name": message.from_user.full_name,
        "screenshot_id": message.photo[-1].file_id,
        "prize_amount": prize_amount,
        "phone": None,
        "bank": None
    }
    
    # –°–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–∏–Ω—è—Ç–∏–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞
    success_text = f"""‚úÖ –û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞!

–°–∫—Ä–∏–Ω—à–æ—Ç –ø—Ä–∏–Ω—è—Ç –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω! 
–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–∑—ã–≤! üôè

üéâ –í–∞—à –≤—ã–∏–≥—Ä—ã—à: {prize_amount} —Ä—É–±–ª–µ–π!

–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ–Ω–µ–∂–Ω–æ–≥–æ –ø—Ä–∏–∑–∞ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:
+7XXXXXXXXXX –∏–ª–∏ 8XXXXXXXXXX

–ü—Ä–∏–º–µ—Ä: +79123456789"""
    
    await message.answer(success_text)
    await state.set_state(UserState.waiting_for_phone)

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
@dp.message(UserState.waiting_for_phone, F.text)
async def process_phone(message: Message, state: FSMContext):
    phone = message.text.strip()
    
    # –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    if not (phone.startswith('+7') or phone.startswith('8')) or len(phone.replace('+', '')) != 11:
        await message.answer("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ:\n+7XXXXXXXXXX –∏–ª–∏ 8XXXXXXXXXX\n\n–ü—Ä–∏–º–µ—Ä: +79123456789")
        return
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    if message.from_user.id in user_data:
        user_data[message.from_user.id]["phone"] = phone
    
    bank_request = """üìã –û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å —É–∫–∞–∂–∏—Ç–µ –≤–∞—à –±–∞–Ω–∫ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞:

–ù–∞–ø—Ä–∏–º–µ—Ä:
- –°–±–µ—Ä–±–∞–Ω–∫
- –¢–∏–Ω—å–∫–æ—Ñ—Ñ
- –ê–ª—å—Ñ–∞-–ë–∞–Ω–∫
- –í–¢–ë
- –∏–ª–∏ –¥—Ä—É–≥–æ–π –±–∞–Ω–∫

–û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–∞–Ω–∫–∞:"""
    
    await message.answer(bank_request)
    await state.set_state(UserState.waiting_for_bank)

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∑–≤–∞–Ω–∏—è –±–∞–Ω–∫–∞
@dp.message(UserState.waiting_for_bank, F.text)
async def process_bank(message: Message, state: FSMContext):
    bank = message.text.strip()
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –±–∞–Ω–∫
    if message.from_user.id in user_data:
        user_data[message.from_user.id]["bank"] = bank
        
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_info = user_data[message.from_user.id]
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏
        final_message = f"""üéä –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –ó–∞—è–≤–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞!

‚úÖ –î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—ã–ø–ª–∞—Ç—ã:
- –°—É–º–º–∞: {user_info['prize_amount']} —Ä—É–±–ª–µ–π
- –¢–µ–ª–µ—Ñ–æ–Ω: {user_info['phone']}
- –ë–∞–Ω–∫: {bank}

‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–ø–ª–∞—Ç—ã:
–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞. 
–í—ã–ø–ª–∞—Ç—ã –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤.

üí∞ –î–µ–Ω—å–≥–∏ –±—É–¥—É—Ç –ø–µ—Ä–µ–≤–µ–¥–µ–Ω—ã –≤ —Ç–µ—á–µ–Ω–∏–µ 1-3 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π.

–°–ø–∞—Å–∏–±–æ –∑–∞ —É—á–∞—Å—Ç–∏–µ! üéâ

–î–ª—è –Ω–æ–≤–æ–≥–æ –±–æ–Ω—É—Å–∞ –Ω–∞–∂–º–∏—Ç–µ /start"""
        
        await message.answer(final_message)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞—è–≤–∫—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
        await send_to_admin(user_info)
    
    await state.clear()

# –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
async def send_to_admin(user_info):
    admin_message = f"""üì® –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –±–æ–Ω—É—Å!

üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:
ID: {user_info['user_id']}
–ò–º—è: {user_info['full_name']}
Username: @{user_info['username'] if user_info['username'] else '–ù–µ —É–∫–∞–∑–∞–Ω'}

üí∞ –°—É–º–º–∞: {user_info['prize_amount']} —Ä—É–±.
üì± –¢–µ–ª–µ—Ñ–æ–Ω: {user_info['phone']}
üè¶ –ë–∞–Ω–∫: {user_info['bank']}

–°–∫—Ä–∏–Ω—à–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω."""
    
    try:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        await bot.send_message(ADMIN_ID, admin_message)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∫—Ä–∏–Ω—à–æ—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å)
        if user_info.get('screenshot_id'):
            await bot.send_photo(ADMIN_ID, user_info['screenshot_id'], 
                                 caption="–°–∫—Ä–∏–Ω—à–æ—Ç –æ—Ç–∑—ã–≤–∞")
        
        logger.info(f"–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_info['user_id']}")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞—è–≤–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É: {e}")

# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏—è—Ö
@dp.message()
async def handle_other_messages(message: Message):
    if message.text and not message.text.startswith('/'):
        await message.answer("–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–Ω—É—Å–∞ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ /start", 
                           reply_markup=get_main_keyboard())

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞
async def main():
    logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    await dp.start_polling(bot)

if __name__ == "__main__":
    import asyncio
    asyncio.run(main())
